<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>CRM Photovolta√Øque</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAPz59eSA-UkT2AzlQzXslwzt8V5uftFzM&libraries=places"></script>
  <style>
    body { font-family: Arial; background: #f4f4f4; padding: 20px; margin: 0; }
    form {
      background: white;
      padding: 20px;
      border-radius: 10px;
      max-width: 600px;
      margin: auto;
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.1);
    }
    h2 { text-align: center; font-size: 24px; color: #093661; margin-bottom: 20px; }
    input, select, button, a {
      width: 100%;
      padding: 14px;
      margin: 12px 0;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
      text-align: center;
      display: block;
      text-decoration: none;
    }
    label { font-weight: bold; display: block; margin: 10px 0 5px; font-size: 16px; color: #093661; }
    .checkbox-container { margin-top: 10px; }
    button, a {
      background-color: #093661;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover, a:hover { background-color: #0b477e; }
    @media screen and (max-width: 600px) {
      input, select, button, a { font-size: 18px; padding: 16px; }
      label { font-size: 17px; }
      h2 { font-size: 22px; }
    }
  </style>
</head>
<body>
  <form id="crmForm">
    <h2>Prospection</h2>
    <input type="text" id="nomprenom" placeholder="Nom Pr√©nom" required>
    <input id="autocomplete" placeholder="Adresse compl√®te" type="text" />
    <input id="codepostal" placeholder="Code postal" type="text" readonly />
    <input id="ville" placeholder="Ville" type="text" readonly />
    <input type="tel" id="tel" placeholder="T√©l√©phone (facultatif)">
    <input type="email" id="mail" placeholder="Email (facultatif)">

    <label for="daterdv">üóì Choisir une date</label>
    <input type="date" id="daterdv">

    <label for="heurerdv">üïí Choisir une heure</label>
    <select id="heurerdv">
      <option value="">-- Choisir une heure --</option>
      <option>08:00</option><option>08:15</option><option>08:30</option><option>08:45</option>
      <option>09:00</option><option>09:15</option><option>09:30</option><option>09:45</option>
      <option>10:00</option><option>10:15</option><option>10:30</option><option>10:45</option>
      <option>11:00</option><option>11:15</option><option>11:30</option><option>11:45</option>
      <option>12:00</option><option>12:15</option><option>12:30</option><option>12:45</option>
      <option>13:00</option><option>13:15</option><option>13:30</option><option>13:45</option>
      <option>14:00</option><option>14:15</option><option>14:30</option><option>14:45</option>
      <option>15:00</option><option>15:15</option><option>15:30</option><option>15:45</option>
      <option>16:00</option><option>16:15</option><option>16:30</option><option>16:45</option>
      <option>17:00</option><option>17:15</option><option>17:30</option><option>17:45</option>
      <option>18:00</option><option>18:15</option><option>18:30</option><option>18:45</option>
    </select>

    <div class="checkbox-container">
      <label><input type="checkbox" id="avp"> üñã J'ai laiss√© un avis de passage (AVP)</label>
    </div>

    <button type="submit">Envoyer vers Google Sheets</button>
    <button type="button" onclick="openGoogleAgenda()">Cr√©er RDV dans Google Agenda</button>
        <a href="#" id="btnLocus" target="_blank" style="display:none;">üó∫Ô∏è Ouvrir dans Locus Map</a>
  </form>

  <script>
    let autocomplete;
    let lat = null, lng = null;

    function initAutocomplete() {
      autocomplete = new google.maps.places.Autocomplete(
        document.getElementById("autocomplete"),
        { types: ["geocode"], componentRestrictions: { country: "fr" } }
      );
      autocomplete.addListener("place_changed", fillInAddress);
    }

    function fillInAddress() {
  const place = autocomplete.getPlace();
  lat = place.geometry.location.lat();
  lng = place.geometry.location.lng();

  let postal = "", city = "";
  for (const comp of place.address_components) {
    if (comp.types.includes("postal_code")) postal = comp.long_name;
    if (comp.types.includes("locality")) city = comp.long_name;
  }
  document.getElementById("codepostal").value = postal;
  document.getElementById("ville").value = city;

  let address = place.formatted_address;
  if (postal) address = address.replace(postal, "");
  if (city) address = address.replace(city, "");
  address = address.replace("France", "")
                   .replace("FRANCE", "")
                   .replace(/,+/g, ",")
                   .replace(/,\s*$/, "")
                   .trim();

  document.getElementById("autocomplete").value = address;

  const btn = document.getElementById("btnLocus");
  if (lat && lng) {
    btn.href = `geo:${lat},${lng}`;
    btn.style.display = "block";
  }
}


    function copierAdresse() {
      const adresse = document.getElementById("autocomplete").value;
      const cp = document.getElementById("codepostal").value;
      const ville = document.getElementById("ville").value;
      const fullAdresse = `${adresse}, ${cp} ${ville}`;

      navigator.clipboard.writeText(fullAdresse)
        .then(() => alert("Adresse compl√®te copi√©e !"))
        .catch(() => alert("√âchec de la copie."));
    }

    window.onload = initAutocomplete;

    document.getElementById("crmForm").addEventListener("submit", function(e) {
      e.preventDefault();

      const isAVP = document.getElementById("avp").checked;
      const date = document.getElementById("daterdv").value;
      const heure = document.getElementById("heurerdv").value;

      if (!isAVP && (!date || !heure)) {
        alert("Merci de renseigner la date et l'heure du RDV ou de cocher AVP.");
        return;
      }

      const now = new Date().toLocaleString("fr-FR");
      const data = {
        dateheure: now,
        nomprenom: document.getElementById("nomprenom").value,
        adresse: document.getElementById("autocomplete").value,
        cp: document.getElementById("codepostal").value,
        ville: document.getElementById("ville").value,
        tel: document.getElementById("tel").value,
        mail: document.getElementById("mail").value,
        daterdv: isAVP ? "AVP" : date,
        heurerdv: isAVP ? "" : heure,
      };

      fetch("https://script.google.com/macros/s/AKfycbwqm952RFZA8DieF-_a7g_Y83_GZ_xH91AuY2jFnMzbBkrsrSIxweNm1kBQ2NVzwz3_1g/exec", {
        method: "POST",
        body: JSON.stringify(data),
      })
      .then(res => alert("Donn√©es envoy√©es avec succ√®s !"))
      .catch(err => alert("Erreur lors de l'envoi."));
    });

    function openGoogleAgenda() {
      if (document.getElementById("avp").checked) {
        alert("Pas de RDV √† cr√©er si AVP.");
        return;
      }

      const nomprenom = document.getElementById("nomprenom").value;
      const adresse = document.getElementById("autocomplete").value;
      const cp = document.getElementById("codepostal").value;
      const ville = document.getElementById("ville").value;
      const date = document.getElementById("daterdv").value;
      const heure = document.getElementById("heurerdv").value;

      if (!date || !heure) {
        alert("Merci de renseigner la date et l'heure du RDV");
        return;
      }

      const fullAddress = `${adresse}, ${cp} ${ville}`;
      const start = new Date(date + "T" + heure);
      const end = new Date(start.getTime() + 2 * 60 * 60000);
      const startUTC = start.toISOString().replace(/-|:|\.\d\d\d/g, "");
      const endUTC = end.toISOString().replace(/-|:|\.\d\d\d/g, "");

      const description = `Rendez-vous commercial ‚Äì Voir votre planning du jour : https://calendar.google.com/calendar/r/day/${date}`;
      const eventURL = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=RDV+${encodeURIComponent(nomprenom)}&dates=${startUTC}/${endUTC}&location=${encodeURIComponent(fullAddress)}&details=${encodeURIComponent(description)}`;

      window.open(eventURL, "_blank");
    }
  </script>
</body>
</html>
